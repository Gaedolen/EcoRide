{% extends 'base.html.twig' %}

{% block title %}D√©tails du covoiturage{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ asset('/css/detailsCovoiturage.css') }}">
{% endblock %}

{% block body %}
    <div class="details-header">
        <h2>D√©tails du covoiturage</h2>
        {% if app.user.id != trajet.utilisateur_id %}
            <form method="POST" action="{{ path('reserver_trajet', { id: trajet.id }) }}">
                <input type="hidden" name="_token" value="{{ csrf_token('reserver_covoiturage_' ~ trajet.id) }}">
                
                <button type="button" 
                        class="btn-reserver {% if app.user.credits < 2 %}disabled-btn{% endif %}" 
                        data-credits="{{ app.user.credits }}"
                        {% if app.user.credits < 2 %}disabled{% endif %}>
                    Covoiturer !
                </button>
            </form>
        {% else %}
            <button class="btn-reserver disabled-btn" onclick="return false;">
                Vous √™tes le conducteur
            </button>
        {% endif %}
    </div>

    <div class="carte-details">
        <div class="details-col conducteur">
            <img src="{{ trajet.chauffeur_photo ? 'data:image/jpeg;base64,' ~ trajet.chauffeur_photo : asset('images/se-connecter.png') }}" class="chauffeur-photo" alt="Photo">
            <p class="chauffeur-name">{{ trajet.chauffeur_pseudo }}</p>
            <p><strong>Note : </strong>{{ trajet.chauffeur_note ?? 'Non not√©' }}/5</p>
        </div>

        <div class="separator-vertical"></div>

        <div class="details-col trajet">
            <h3>Trajet</h3>
            <p><strong>D√©part :</strong> {{ trajet.lieu_depart }} - {{ trajet.date_depart|date('d/m') }} √† {{ trajet.heure_depart|date('H:i') }}</p>
            <p><strong>Arriv√©e :</strong> {{ trajet.lieu_arrivee }} - {{ trajet.date_arrivee|date('d/m') }} √† {{ trajet.heure_arrivee|date('H:i') }}</p>

            {% set duree = trajet.heure_arrivee.timestamp - trajet.heure_depart.timestamp %}
            {% set h = duree // 3600 %}
            {% set m = (duree % 3600) // 60 %}
            <p><strong>Dur√©e :</strong> {{ trajet.duree_heures }}h{% if trajet.duree_minutes > 0 %} {{ trajet.duree_minutes }}min{% endif %}</p>

            <p><strong>Places disponibles :</strong> {{ trajet.nb_place }}</p>
            <p><strong>Prix :</strong> {{ trajet.prix_personne }} ‚Ç¨</p>
            {% if trajet.energie in ['√âlectrique', 'Electrique'] %}
                <span class="eco-badge">üå± √âcologique</span>
            {% endif %}
        </div>

        <div class="separator-vertical"></div>

        <div class="details-col voiture">
            <h3>V√©hicule</h3>
            <p><strong>Marque :</strong> {{ trajet.marque }}</p>
            <p><strong>Mod√®le :</strong> {{ trajet.modele }}</p>
            <p><strong>√ânergie :</strong> {{ trajet.energie }}</p>
            <p><strong>Couleur :</strong> {{ trajet.couleur }}</p>
            <p><strong>Animaux :</strong> {{ trajet.animaux ? 'Oui' : 'Non' }}</p>
            <p><strong>Fumeur :</strong> {{ trajet.fumeur ? 'Oui' : 'Non' }}</p>
            {% if trajet.preferences is not empty %}
                <div class="preferences-section">
                    <p><strong>Pr√©f√©rences personnalis√©es :</strong></p>
                    <ul class="preferences-list">
                        {% for pref in trajet.preferences %}
                            <li><span class="pastille"></span>{{ pref }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        </div>
    </div>


    <div class="btn-retour-wrapper">
        <a href="{{ path('app_covoiturage', {
            lieu_depart: app.request.get('lieu_depart'),
            lieu_arrivee: app.request.get('lieu_arrivee'),
            date_depart: app.request.get('date_depart'),
            heure_depart: app.request.get('heure_depart'),
            note_min: app.request.get('note_min'),
            ecologique: app.request.get('ecologique'),
            prix_min: app.request.get('prix_min'),
            prix_max: app.request.get('prix_max'),
            temps_max: app.request.get('temps_max')
        }) }}" class="btn-retour">‚Üê Retour √† la recherche</a>
    </div>

    <div class="avis-section">
        <h2>Avis sur le conducteur</h2>

        {% if avis is not empty %}
            {% for avisItem in avis %}
                <div class="avis-card">
                    <p class="avis-note">Note : {{ avisItem.note }}/5</p>
                    <p class="avis-commentaire">"{{ avisItem.commentaire }}"</p>
                    <p class="avis-auteur">Post√© par {{ avisItem.auteur_pseudo ?? 'Utilisateur anonyme' }}</p>
                </div>
            {% endfor %}
        {% else %}
            <p class="no-avis">Ce conducteur n'a pas encore d'avis.</p>
        {% endif %}
    </div>

    <!-- Modal de confirmation avant r√©servation -->
    <div id="reservation-modal" class="modal hidden">
        <div class="modal-content">
            <p id="reservation-message"></p>
            <div class="modal-buttons">
                <button type="button" class="btn-confirm-yes">Oui</button>
                <button type="button" class="btn-confirm-no">Non</button>
            </div>
        </div>
    </div>

    {% block javascripts %}
        <script src="{{ asset('/js/detailsCovoiturage.js') }}"></script>
    {% endblock %}

{% endblock %}
