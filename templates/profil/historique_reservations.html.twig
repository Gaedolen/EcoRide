{% extends 'base.html.twig' %}

{% block head %}
    <link rel="stylesheet" href="{{ asset('/css/profil/historique_reservations.css') }}">
{% endblock %}

{% block title %}Historique des r√©servations{% endblock %}

{% block body %}
    <div class="historique-reservations-container">

        <h1 class="main-title">üìú Historique de mes r√©servations</h1>

        {% set reservationsParMois = {} %}
        {% for resa in reservations %}
            {% if resa.covoiturage_statut == 'ferme' %}
                {% set mois = resa.date_depart|date('Y-m') %}
                {% if reservationsParMois[mois] is not defined %}
                    {% set reservationsParMois = reservationsParMois|merge({(mois): []}) %}
                {% endif %}
                {% set reservationsParMois = reservationsParMois|merge({(mois): reservationsParMois[mois]|merge([resa])}) %}
            {% endif %}
        {% endfor %}

        {% for mois, resas in reservationsParMois %}
            {% set moisTexte = resas[0].date_depart|date('F Y') %}
            {% set moisTexteFR = {
                'January':'Janvier','February':'F√©vrier','March':'Mars','April':'Avril','May':'Mai','June':'Juin',
                'July':'Juillet','August':'Ao√ªt','September':'Septembre','October':'Octobre','November':'Novembre','December':'D√©cembre'
            }[moisTexte|split(' ')[0]] ~ ' ' ~ moisTexte|split(' ')[1] %}

            <h2 class="month-title">
                <span class="month-bullet"></span> {{ moisTexteFR }}
            </h2>

            <div class="reservations-section">
                {% for resa in resas %}
                    <div class="details-card past-reservation">
                        <div class="details-card-header">
                            <div class="details-title">
                                <h2>Trajet du {{ resa.date_depart|date('d/m/Y') }} vers {{ resa.lieu_arrivee }}</h2>
                            </div>
                            <div class="boutons-container">
                                {% set avis = resa.avis_existant %}
                                {% set signalement = resa.signalement_existant %}

                                <!-- Bouton avis -->
                                {% if avis %}
                                    {% if avis.is_validated %}
                                        <span class="badge badge-success">‚úÖ Avis d√©pos√©</span>
                                    {% else %}
                                        <span class="badge badge-warning">‚è≥ Avis en attente</span>
                                    {% endif %}
                                {% else %}
                                    <button type="button" class="btn btn-avis open-avis-popup"
                                        data-avis-covoiturage-id="{{ resa.covoiturage_id }}"
                                        data-cible-id="{{ resa.chauffeur_id }}">
                                        Laisser un avis
                                    </button>
                                {% endif %}

                                <!-- Bouton signalement -->
                                {% if signalement %}
                                    {% if signalement.statut == 'en_attente' %}
                                        <span class="badge badge-warning">‚è≥ Signalement en attente</span>
                                    {% elseif signalement.statut == 'traite' %}
                                        <span class="badge badge-success">‚úÖ Trait√©</span>
                                    {% elseif signalement.statut == 'ignore' %}
                                        <span class="badge badge-danger">‚ùå Ignor√©</span>
                                    {% endif %}
                                {% else %}
                                    <button type="button" class="btn btn-signalement open-report-popup"
                                        data-reported-user-id="{{ resa.chauffeur_id }}"
                                        data-covoiturage-id="{{ resa.covoiturage_id }}">
                                        Signaler
                                    </button>
                                {% endif %}
                            </div>
                        </div>

                        <div class="grayscale-wrapper">
                            <div class="details-content">
                                <!-- Bloc conducteur -->
                                <div class="bloc bloc-conducteur">
                                    <h3>Conducteur</h3>
                                    <img src="{{ resa.chauffeur_photo ? 'data:image/jpeg;base64,' ~ resa.chauffeur_photo : asset('images/se-connecter.png') }}" alt="Photo" class="chauffeur-photo">
                                    <p><strong>{{ resa.chauffeur_pseudo }}</strong></p>
                                    <p><strong>Note : </strong>{{ resa.chauffeur_note ?? 'Non not√©' }}/5</p>
                                </div>

                                <!-- Ligne verticale -->
                                <div class="separator-vertical"></div>

                                <!-- Bloc trajet -->
                                <div class="bloc bloc-trajet">
                                    <h3>Trajet</h3>
                                    <p><strong>D√©part :</strong> {{ resa.lieu_depart }}, {{ resa.date_depart|date('d/m/Y') }} √† {{ resa.heure_depart|date('H:i') }}</p>
                                    <p><strong>Arriv√©e :</strong> {{ resa.lieu_arrivee }}, {{ resa.date_arrivee|date('d/m/Y') }} √† {{ resa.heure_arrivee|date('H:i') }}</p>
                                    <p><strong>Prix :</strong> {{ resa.prix_personne|number_format(2, ',', ' ') }} ‚Ç¨</p>
                                    <p><strong>Places :</strong> {{ resa.nb_place }}</p>
                                    {% if resa.voiture_energie in ['√âlectrique', 'Electrique'] %}
                                        <span class="eco-badge">üå± √âcologique</span>
                                    {% endif %}
                                </div>

                                <!-- Ligne verticale -->
                                <div class="separator-vertical"></div>

                                <!-- Bloc voiture -->
                                <div class="bloc bloc-voiture">
                                    <h3>V√©hicule</h3>
                                    {% if resa.marque is not empty %}
                                        <p><strong>Marque :</strong> {{ resa.marque }}</p>
                                        <p><strong>Mod√®le :</strong> {{ resa.modele }}</p>
                                        <p><strong>Couleur :</strong> {{ resa.couleur }}</p>
                                        <p><strong>√ânergie :</strong> {{ resa.voiture_energie }}</p>
                                    {% else %}
                                        <p><em>La voiture a √©t√© supprim√©e</em></p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>

    <div id="avis-popup" class="popup-overlay" style="display:none;"> <!-- Fen√™tre pop-up pour laisser un avis -->
        <div class="popup-content">
            <button class="close-popup" aria-label="Fermer">&times;</button>

            <form method="POST" action="{{ path('laisser_avis') }}">
                <input type="hidden" name="cible_id" id="cible_id" value="">
                <input type="hidden" name="covoiturage_id" id="covoiturage_id" value="">
                <input type="hidden" name="_token" value="{{ csrf_token('laisser-avis') }}">

                <label for="note">Note (1 √† 5) :</label>
                <select name="note" id="note" required>
                    <option value="">-- Choisir --</option>
                    {% for i in 1..5 %}
                        <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                </select>

                <label for="commentaire">Commentaire :</label>
                <textarea name="commentaire" id="commentaire" rows="4" required></textarea>

                <button type="submit" class="btn btn-primary">Envoyer</button>
            </form>
        </div>
    </div>

    {% include 'report/_form_popup.html.twig' %} <!-- Fen√™tre pop-up pour signaler un utilisateur -->

    {% block javascripts %}
        <script src="{{ asset('js/historique_reservations.js') }}"></script>
    {% endblock %}

{% endblock %}
